# AI数据库智能体系统 (问库智能体)

## 系统概述

问库智能体是一个基于AgentCore框架开发的人工智能数据库查询系统。它通过集成Ollama大模型，能够将用户的自然语言问题转换为SQL查询语句，并自动执行查询返回结果。

## 系统架构

### 核心组件

1. 🤖 **AIDBAgent (问库智能体)**
   - 系统的核心智能体
   - 负责处理自然语言查询请求
   - 通过大模型生成SQL语句
   - 执行查询并返回格式化结果

2. 📱**QueryClientAgent (查询客户端智能体)**
   - 用于发送查询请求的客户端智能体
   - 支持定时发送示例查询
   - 处理和展示查询响应

3. 🔍**DatabaseMetadataService (数据库元数据服务)**
   - 获取和管理数据库表结构信息
   - 提供表和字段的元数据
   - 支持基于关键词的表搜索

4. 🧠**OllamaService (Ollama大模型服务)**
   - 与Ollama API进行交互
   - 生成SQL查询语句
   - 支持连接测试和错误处理

5. 💾**DatabaseQueryService (数据库查询服务)**
   - 执行SQL查询
   - 验证SQL安全性
   - 格式化查询结果

6. 📋 **DatabaseConfig (数据库配置)**
   - 集中管理系统配置
   - 数据库连接参数
   - Ollama服务配置
7. 🏛️ **AIDBSystem.java - 主系统类**
   - 系统启动和容器管理
   - 智能体创建和协作关系设置
   - 交互式查询模式
   - 完整的用户界面和命令处理

## 配置信息

### 数据库配置
- **地址**: 127.0.0.1:3306
- **数据库**: gis-pro
- **用户名**: user
- **密码**: password

### Ollama大模型配置
- **地址**: 127.0.0.1:11434
- **模型**: deepseekr1:7b
- **API端点**: /api/generate

## 功能特点

### 1. 自然语言查询
- 支持中文自然语言查询
- 自动理解用户意图
- 智能匹配相关数据表

### 2. 安全性保障
- 只允许SELECT查询操作
- 自动过滤危险SQL关键字
- 限制查询结果数量

### 3. 智能SQL生成
- 基于数据库元数据生成准确SQL
- 使用专业的提示词模板
- 支持复杂查询逻辑

### 4. 结果格式化
- 表格形式展示查询结果
- 显示列信息和数据类型
- 支持大结果集的分页显示

### 5.🔒 安全性保障
- SQL注入防护：只允许SELECT查询，过滤危险关键字
- 结果限制：限制查询结果数量，防止内存溢出
- 连接管理：自动管理数据库连接池

### 6.🧠 智能化特性
- 自然语言理解：支持中文自然语言查询
- 智能SQL生成：基于数据库元数据生成准确SQL
- 上下文理解：理解用户查询意图和数据库结构

### 7.🚀 高性能设计
- 异步处理：响应式消息处理机制
- 缓存优化：元数据缓存提高查询效率
- 连接池：数据库连接池管理

### 8.🎯 用户友好
- 交互式界面：命令行交互式查询模式
示例演示：内置查询示例和自动演示
- 错误提示：友好的错误信息和帮助说明

## 🎮 使用方法

### 1. 启动系统
```bash
java com.agentcore.examples.aidb.AIDBSystem
```

### 2. 交互式查询
系统启动后会进入交互式模式，用户可以输入自然语言查询：

```
🤖 请输入查询问题: 查询所有表的信息
🤖 请输入查询问题: 显示用户表的结构
🤖 请输入查询问题: 统计数据库中有多少个表
```

### 3. 特殊命令
- `help`: 显示帮助信息
- `demo`: 运行自动演示
- `quit` 或 `exit`: 退出系统

## 查询示例

### 基础查询
- "查询所有表的信息"
- "显示用户表的结构"
- "统计数据库中有多少个表"

### 数据查询
- "查询最近的数据记录"
- "显示所有表名"
- "查找包含用户信息的表"

### 统计查询
- "统计每个表的记录数量"
- "查询表的字段信息"
- "显示数据库概览"

## 🔄 工作流程
🚀 系统启动：创建AgentCore容器，初始化智能体
🔗 智能体协作：客户端智能体与问库智能体建立通信
📝 自然语言输入：用户输入中文自然语言查询
🧠 AI理解：问库智能体通过Ollama大模型理解用户意图
🔍 元数据获取：获取相关数据库表结构信息
⚙️ SQL生成：基于元数据和用户问题生成SQL语句
🛡️ 安全验证：验证SQL安全性，只允许SELECT查询
💾 查询执行：执行SQL并获取结果
📊 结果格式化：将结果格式化为易读的表格形式
📱 响应返回：将结果返回给客户端智能体展示

## 技术实现

### 1. 多智能体协作
- 基于AgentCore框架的智能体通信
- 异步消息处理机制
- 响应式架构设计

### 2. 大模型集成
- HTTP客户端与Ollama API交互
- JSON格式的请求和响应处理
- 智能的SQL提取算法

### 3. 数据库操作
- JDBC连接池管理
- 元数据自动获取
- 安全的SQL执行

### 4. 错误处理
- 完善的异常处理机制
- 连接超时和重试逻辑
- 用户友好的错误信息

## 扩展功能

### 1. 支持更多数据库
- 可扩展支持PostgreSQL、Oracle等
- 数据库方言适配
- 连接池优化

### 2. 查询优化
- SQL性能分析
- 查询缓存机制
- 结果集优化

### 3. 安全增强
- 用户权限管理
- 查询审计日志
- 敏感数据脱敏

## 注意事项

1. **安全限制**: 系统只允许SELECT查询，不支持数据修改操作
2. **结果限制**: 查询结果默认限制为1000行，防止内存溢出
3. **连接管理**: 系统会自动管理数据库连接，无需手动关闭
4. **模型依赖**: 需要确保Ollama服务正常运行且模型已加载

## 故障排除

### 1. 数据库连接失败
- 检查数据库服务是否运行
- 验证连接参数是否正确
- 确认网络连通性

### 2. Ollama服务不可用
- 检查Ollama服务状态
- 验证模型是否已加载
- 确认API端点配置

### 3. SQL生成错误
- 检查数据库元数据是否正确加载
- 验证用户查询的语义清晰度
- 查看日志中的详细错误信息

## 开发者信息

- **框架**: AgentCore
- **开发语言**: Java
- **数据库**: MySQL
- **AI模型**: Ollama gpt-oss:20b
- **版本**: 1.0

## 🔧 技术栈
框架：AgentCore多智能体框架
AI模型：Ollama gpt-oss:20b
数据库：MySQL (source_data_warehouse)
通信：HTTP客户端与Ollama API交互
架构：响应式多智能体协作系统
